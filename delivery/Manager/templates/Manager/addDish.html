{% extends 'Manager/base.html' %}

{% block title %}菜单{% endblock %}

{% load static %}

{% block content %}
<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">菜单</h1>
</div>

  <div id="holder" class="row">

    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold shadow text-primary" id="name" contenteditable="true">输入菜名</h6>
        <select class="mt-2" name="type" id="dish_type">
          {% for term in dish_types %}
             <option value="{{term}}">{{term}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="card-body row no-gutters align-items-center">
        <div class="col-md-5 mr-2">
          <img class="dropdown-list-image col-md-11" id="picture" src="{% static 'Manager/images/defaultimage.jpg'%} ">
          <label class="btn btn-primary" for="image_upload" style="width=auto;display:inline-block;">图片</label>
          <input id="image_upload" style="display:none;" type="file"/>
        </div>
          <div class="col-6 mr-2">
            <div class="h5 mb-2 mt-2 font-weight-bold text-gray-800">$<p class="shadow" id="price" contenteditable="true" style="display:inline"></p></div>
            <div class="h5 font-weight-bold text-primary mb-1">描述</div>
            <div class="h6 font-weight-bold text-black-50 mb-1 shadow" id="description" contenteditable="true">编辑这里</div>
          </div>
          <select class="mr-2 mt-2" name="availability" id="availablity">
              <option value="False">售罄</option>
              <option value="True" selected="selected">有货</option>
            </select>
          <button id="save_button" class="mr-2 mt-2 btn btn-success">储存</button>

      </div>
    </div>

  </div>
  <script type="text/javascript">

  var dish_pic = document.getElementById("picture");
  // button to upload the new image
  var pic_upload = document.getElementById("image_upload");
  // change the image when a new image is uploaded
  pic_upload.addEventListener('change', function(e){
      e.preventDefault();
      if (this.files && this.files[0]) {
        var reader = new FileReader();
        if (testFileType(this.files[0].type)){
          reader.readAsDataURL(this.files[0]);
          reader.onload = function (e) {
            dish_pic.src = e.target.result;
          };
        }
        else{
          this.value = null;
        }
    }
  }, false);

  // buttons to manipulate the dish info
  var save_button = document.getElementById("save_button");
  save_button.onclick=function(){
    // https://stackoverflow.com/questions/17832194/get-javascript-variables-value-in-django-url-template-tag
    let header = document.getElementById("name");
    let dish_availability = document.getElementById("availablity");
    let dish_price_num = document.getElementById("price");
    let dish_descr = document.getElementById("description");
    let dish_type = document.getElementById("dish_type");
    let dish_data = {
      'name': header.innerHTML,
      'availability': dish_availability.options[dish_availability.selectedIndex].value,
      'price': dish_price_num.innerHTML,
      'description': dish_descr.innerHTML,
      'type': dish_type.options[dish_type.selectedIndex].value
    };
    if (pic_upload.value != null){
      dish_data["picture"] = pic_upload.value;
    }
    //JSON.stringify(img);
    updateDish(dish_url, dish_data);
  };


  function testFileType(type) {
    switch (type) {
       case 'image/jpeg':
       case 'image/jpg':
       case 'image/gif':
       case 'image/png':
       return true;
     }
     return false;
  }

  function updateDish(url, dish_data) {
    var request = new Request(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                data: dish_data,
                });
    return fetch(request).then((response) => {
      if (response.status === 200) { // OK
        return response.json(); // return a Promise
      } else {
        alert("Something went wrong: " + response.status);
      }
    });
  }

</script>


{% endblock %}
