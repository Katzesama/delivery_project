{% extends 'base.html' %}

{% block title %}待处理订单{% endblock %}

{% block content %}
{% load static %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">待处理订单</h1>
  <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-download fa-sm text-white-50"></i> Generate Report</a>
</div>

  <div id="holder" class="row"></div>
  <script type="text/javascript">
  var holder = document.getElementById("holder");

  function show_order(data) {
    //clear the older content from last request
    while(holder.hasChildNodes()){
			holder.removeChild(holder.firstChild);
    }

    // loop through and create a section for each order sent by at the current page
    for (var i = 0; i < data.orders.length; i++) {
      // most outter container of the order section
      let order = document.createElement("div");
      order.class = "card shadow mb-4";
      holder.appendChild(order);

      // add header to the order section
      let header_ct = document.createElement("div");
      header_ct.class = "card-header py-3";
      order.appendChild(header_ct);
      let header = document.createElement("h6");
      header.class = "m-0 font-weight-bold text-primary";
      header.innerHTML = "订单号：" + data.orders[i].order_num;
      header_ct.appendChild(header);

      // add the body part to the order section
      let body = document.createElement("div");
      body.class = "card-body row no-gutters align-items-center";
      order.appendChild(body);
      // display the information of the order
      let order_info = document.createElement("div");
      order_info.class = "col-6 mr-2";
      body.appendChild(order_info);
      // deliver address of the order
      let deliver_addr = document.createElement("div");
      deliver_addr.class = "h6 mb-1 font-weight-bold text-gray-800";
      deliver_addr.innerHTML = "" + data.orders[i].deliver_address;
      order_info.appendChild(deliver_addr);
      // phone number and the email address of the custormer
      let customer_phone = document.createElement("div");
      customer_phone.class = "h6 font-weight-bold text-gray-800 mb-1";
      customer_phone.innerHTML = "顾客号码：" + data.orders[i].customer_phone;
      order_info.appendChild(customer_phone);
      let customer_email = document.createElement("div");
      customer_email.class = "h6 font-weight-bold text-gray-800 mb-1";
      customer_email.innerHTML = "顾客邮箱：" + data.orders[i].customer_email;
      order_info.appendChild(customer_email);
      // total price and the detail of the order
      // hide the detail and show when button clicks
      let order_detail = document.createElement("div");
      customer_email.class = "h6 font-weight-bold text-gray-800 mb-1";
      order_info.appendChild(order_detail);
      let total_price = document.createElement("p");
      total_price.innerHTML = "总价：" + data.orders[i].total_price;
      order_detail.appendChild(total_price);
      let more_detail = document.createElement("div");
      more_detail.class = "h7 font-weight-light text-gray-800";
      more_detail.style = "display:none;";
      more_detail.id = "more_detail";
      order_detail.appendChild(more_detail);


      // select the status of the order
      let order_status = document.createElement("select");
      dish_availability.class = "mr-2 mt-2";
      dish_availability.id = "alvaliblity";
      body.appendChild(dish_availability);
      let sold_out = document.createElement("option");
      sold_out.value = "False";
      let available = document.createElement("option");
      available.value = "True";
      if (data.menu[i].availability){
        available.selected = true;
      } else{
        sold_out.selected = true;
      }
      dish_availability.appendChild(sold_out);
      dish_availability.appendChild(available);

      // buttons to manipulate the dish info
      var save_button = document.createElement("button");
      save_button.innerHTML = '储存';
      save_button.class = "mr-2 mt-2 btn btn-success";
      let order_id = data.orders[i].id;
      let order_url = "{% url 'order_detail' 123 %}".replace(/123/, order_id);
      save_button.onclick=function(){
        // https://stackoverflow.com/questions/17832194/get-javascript-variables-value-in-django-url-template-tag
        //"{% url 'someview' arg1=12345 %}".replace(/12345/, tmp.toString());
        let order_data = {
          'name': header.innerHTML,
          'availability': dish_availability.options[dish_availability.selectedIndex].value,
          'price': dish_price_num.innerHTML,
          'description': dish_descr.innerHTML
        };
        //JSON.stringify(img);
        updateOrder(order_url, order_data);
      };

    let line = document.createElement("br");
    holder.appendChild(line);

    // get previous page
    if (data.previous != null)
    {
      let preButton = document.createElement("button");
      preButton.class = "btn btn-light text-grey-600";
      preButton.style = "width=auto;display:inline-block;";
      preButton.innerHTML = '前一页';
      preButton.onclick=function(){
        get_data_display(data.previous);
      };
      holder.appendChild(preButton);
    }

    // https://stackoverflow.com/questions/30864011/display-only-some-of-the-page-numbers-by-django-pagination
    // page number buttons
    for (var i = 0; i < data.count; i++) {
      let page_button = cocument.createElement("button");
      page_button.class = "btn btn-light text-grey-600";
      page_button.style = "width=auto;display:inline-block;";
      page_button.innerHTML = i.toString();
      if (i == data.current){
        page_button.disabled = "true";
        holder.appendChild(page_button);
      }
      else if (i > data.current - 3 || i < data.current + 3) {
        page_button.onclick = function(){
          get_data_display('/menu/api/?page=' + i.toString());
        };
        holder.appendChild(page_button);
      }
    }

    // get next page
    if (data.next != null)
    {
      let nextButton = document.createElement("button");
      nextButton.class = "btn btn-light text-grey-600";
      nextButton.style = "width=auto;display:inline-block;";
      nextButton.innerHTML = '后一页';
      nextButton.onclick=function(){
        get_data_display(data.next);
      };
      holder.appendChild(nextButton);
    }
}

function updateOrder(url, order_data) {
  var request = new Request(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              data: order_data,
              });
  return fetch(request).then((response) => {
    if (response.status === 200) { // OK
      document.location.reload(true);
    } else {
      alert("Something went wrong: " + response.status);
    }
  });
}


  // https://uofa-cmput404.github.io/cmput404-slides/08-AJAX.html#/9
  // https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch
  function fetchJSON(url) {
    var request = new Request(url, {
                method: 'GET',
                headers: {
                     'Content-Type': 'application/json'
                },
                });
    return fetch(request).then((response) => {
      if (response.status === 200) { // OK
        return response.json(); // return a Promise
      } else {
        alert("Something went wrong: " + response.status);
      }
    });
  }


  function get_data_display(url) {
      fetchJSON(url).then(show_order);
  }

  get_data_display("{{fetch_url}}");


</script>
{% endblock %}
